# Load necessary libraries
library(openxlsx)

# Function to calculate the downscaling factor
calculate_downscaling_factor <- function(observed, gcm) {
  factor <- mean(observed, na.rm = TRUE) / mean(gcm, na.rm = TRUE)
  return(factor)
}

# Load observed and GCM data
observed_file <- "D:\\KRB\\GCM arrange\\Observed precipitations.xlsx"
gcm_file <- "D:\\KRB\\GCM arrange\\ACCESS-CM2\\Historical MonthAvg Preci.xlsx"

observed_data <- read.xlsx(observed_file, sheet = 1)
gcm_data <- read.xlsx(gcm_file, sheet = 1)

# Extract station names (assumes they are in the first row after the month column)
stations <- colnames(observed_data)[-1]

# Initialize vectors to store results
downscaling_factors <- c()
downscaled_gcm_data <- observed_data

# Calculate the downscaling factor and apply it for each station
for (station in stations) {
  observed <- observed_data[[station]]
  gcm <- gcm_data[[station]]
  
  factor <- calculate_downscaling_factor(observed, gcm)
  downscaling_factors <- c(downscaling_factors, factor)
  
  # Apply the downscaling factor to GCM data
  downscaled_gcm_data[[station]] <- gcm * factor
}

# Create a data frame for the downscaling factors
downscaling_factors_df <- data.frame(Station = stations, Factor = downscaling_factors)

# Save the downscaling factors and downscaled GCM data
write.xlsx(downscaling_factors_df, "Access CM2 Preci downscaling_factors.xlsx")
write.xlsx(downscaled_gcm_data, "Historical Preci Downscaled.xlsx")

# Load SSP 245 and SSP 585 data
ssp245_file <- "D:\\KRB\\GCM arrange\\ACCESS-CM2\\SSP245_monthly_avg.xlsx"
ssp585_file <- "D:\\KRB\\GCM arrange\\ACCESS-CM2\\SSP585_monthly_avg.xlsx"

ssp245_data <- read.xlsx(ssp245_file, sheet = 1)
ssp585_data <- read.xlsx(ssp585_file, sheet = 1)

# Initialize data frames to store downscaled SSP data
downscaled_ssp245_data <- ssp245_data
downscaled_ssp585_data <- ssp585_data

# Apply the downscaling factor to SSP 245 and SSP 585 data for each station
for (i in seq_along(stations)) {
  station <- stations[i]
  factor <- downscaling_factors[i]
  
  downscaled_ssp245_data[[station]] <- ssp245_data[[station]] * factor
  downscaled_ssp585_data[[station]] <- ssp585_data[[station]] * factor
}

# Save the downscaled SSP data
write.xlsx(downscaled_ssp245_data, "Downscaled_Preci_ssp245.xlsx")
write.xlsx(downscaled_ssp585_data, "Downscaled_Preci_ssp585.xlsx")
